<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fitting Bayesian Multi-resolution Models With `mcmc_mra()` • BayesMRA</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Fitting Bayesian Multi-resolution Models With `mcmc_mra()`">
<meta property="og:description" content="BayesMRA">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">BayesMRA</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/mra-simulation.html">Fitting Bayesian Multi-resolution Models With `mcmc_mra()`</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jtipton25/BayesMRA/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Fitting Bayesian Multi-resolution Models With <code>mcmc_mra()</code>
</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jtipton25/BayesMRA/blob/master/vignettes/mra-simulation.Rmd"><code>vignettes/mra-simulation.Rmd</code></a></small>
      <div class="hidden name"><code>mra-simulation.Rmd</code></div>

    </div>

    
    

<p>In this Vignette, we demonstrate how to fit Bayesian spatial models using the multi-resolution model using Markov Chain Monte Carlo (MCMC).</p>
<div id="defining-the-mra-model" class="section level1">
<h1 class="hasAnchor">
<a href="#defining-the-mra-model" class="anchor"></a>Defining the MRA model</h1>
<p>This package provides a Bayesian implementation of the multi-resolution Gaussian process model presented by <span class="citation">Nychka et al. (2015)</span>. This package is similar to the R package <code><a href="https://rdrr.io/pkg/LatticeKrig/man/LatticeKrig.html">LatticeKrig::LatticeKrig</a></code> (<span class="citation">Nychka et al. (2016)</span>) and provides an implementation that is suitable for use in MCMC samplers.</p>
<p>The model that the function <code><a href="../reference/mcmc_mra.html">mcmc_mra()</a></code> fits is defined below. Let <span class="math inline">\(\mathbf{s}\)</span> be a spatial location in a domain of interest <span class="math inline">\(\mathcal{D}\)</span> and let <span class="math inline">\(y(\mathbf{s})\)</span> be the observation of the spatial process at location <span class="math inline">\(\mathbf{s}\)</span>. Then, we can write the observation as</p>
<p><span class="math display">\[\begin{align*}
y(\mathbf{s}) &amp; = \mathbf{x}(\mathbf{s})' \boldsymbol{\beta} + \eta(\mathbf{s}) + \varepsilon(\mathbf{s}),
\end{align*}\]</span></p>
<p>where <span class="math inline">\(\mathbf{x}(s)\)</span> is a vector of covariates at site <span class="math inline">\(\mathbf{s}\)</span>, <span class="math inline">\(\boldsymbol{\beta}\)</span> are regression coefficients, <span class="math inline">\(\boldsymbol{\eta}(\mathbf{s})\)</span> is the realization of a correlated Gaussian process at location <span class="math inline">\(\mathbf{s}\)</span> and <span class="math inline">\(\varepsilon(\mathbf{s})\)</span> is the realization of an uncorrelated Gaussian error process. The model can be written in matrix form where</p>
<p><span class="math display">\[\begin{align*}
\mathbf{y} &amp; = \mathbf{X} \boldsymbol{\beta} + \boldsymbol{\eta} + \boldsymbol{\varepsilon}.
\end{align*}\]</span></p>
<p>In matrix form, the spatially correlated random process has the distribution <span class="math inline">\(\boldsymbol{\eta} \sim \operatorname{N}(\mathbf{0}, \mathbf{C})\)</span> where the <span class="math inline">\(\mathbf{C}_{ij}\)</span> (the <span class="math inline">\(i\)</span>th row and <span class="math inline">\(j\)</span>th column of <span class="math inline">\(\mathbf{C}\)</span>) is defined as the output of the covariance function <span class="math inline">\(cov(\mathbf{s}_i, \mathbf{s}_j)\)</span> at sites <span class="math inline">\(\mathbf{s}_i\)</span> and <span class="math inline">\(\mathbf{s}_j\)</span>. The residual process <span class="math inline">\(\boldsymbol{\varepsilon} \sim \operatorname{N}(\mathbf{0}, \sigma^2 \mathbf{I})\)</span> models measurement error, commonly referred to as the nugget in the spatial statistics literature.</p>
<p>Rather than specifying a parametric form for the covariance function <span class="math inline">\(cov(\mathbf{s}_i, \mathbf{s}_j)\)</span>, we approximate the covariance function effect with a multi-resolution approximation. This approximation gives <span class="math inline">\(\boldsymbol{\eta} \approx \sum_{m=1}^M \mathbf{W}_m \boldsymbol{\alpha}_m\)</span> where <span class="math inline">\(\mathbf{W}_m\)</span> is the Wendland basis expansion at the <span class="math inline">\(m\)</span>th resolution and <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> are the <span class="math inline">\(m\)</span>th resolution random effect.</p>
</div>
<div id="simulating-data-from-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#simulating-data-from-the-model" class="anchor"></a>Simulating data from the model</h1>
<p>First, we simulate some data from the process of interest. We simulate a spatially explicit set of fired effects X that represent spatial variables like elevation, latitude, etc. Next, the spatial process is initialized</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">11</span>)

<span class="no">N</span> <span class="kw">&lt;-</span> <span class="fl">40</span>^<span class="fl">2</span>

<span class="co">## setup the spatial process</span>
<span class="no">locs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html">expand.grid</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">N</span>)),
    <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span>(<span class="fl">0</span>, <span class="fl">1</span>, <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">N</span>))
  )
)
<span class="no">D</span> <span class="kw">&lt;-</span> <span class="kw pkg">fields</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/fields/man/rdist.html">rdist</a></span>(<span class="no">locs</span>)

<span class="co">## fixed effects include intercept, elevation, and latitude</span>
<span class="no">X</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="kw pkg">mvnfast</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvnfast/man/rmvn.html">rmvn</a></span>(<span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">N</span>), <span class="fl">3</span> * <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span>(-<span class="no">D</span> / <span class="fl">20</span>))), <span class="no">locs</span>[, <span class="fl">2</span>])
<span class="no">p</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>)

<span class="no">beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>))

<span class="co">## MRA spatio-temporal random effect</span>
<span class="no">M</span> <span class="kw">&lt;-</span> <span class="fl">3</span>
<span class="no">n_coarse</span> <span class="kw">&lt;-</span> <span class="fl">10</span>

<span class="no">MRA</span>    <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/mra_wendland_2d.html">mra_wendland_2d</a></span>(<span class="no">locs</span>, <span class="kw">M</span> <span class="kw">=</span> <span class="no">M</span>, <span class="kw">n_coarse</span> <span class="kw">=</span> <span class="no">n_coarse</span>, <span class="kw">use_spam</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="co"># MRA    &lt;- mra_wendland_2d(locs, M = M, n_max_fine_grid = 2^8, use_spam = TRUE)</span>
<span class="no">W_list</span>   <span class="kw">&lt;-</span> <span class="no">MRA</span>$<span class="no">W</span>
<span class="no">n_dims</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">W_list</span>))
<span class="no">dims_idx</span> <span class="kw">&lt;-</span> <span class="kw">NULL</span>
<span class="kw">for</span> (<span class="no">i</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">M</span>) {
  <span class="no">n_dims</span>[<span class="no">i</span>] <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">W_list</span><span class="kw">[[</span><span class="no">i</span>]])
  <span class="no">dims_idx</span>  <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">dims_idx</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">i</span>, <span class="no">n_dims</span>[<span class="no">i</span>]))
}
<span class="no">W</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">cbind</span>, <span class="no">W_list</span>)

<span class="no">Q_alpha</span>      <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/make_Q_alpha_2d.html">make_Q_alpha_2d</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">n_dims</span>), <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0.999</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">n_dims</span>)), <span class="kw">prec_model</span> <span class="kw">=</span> <span class="st">"CAR"</span>)

<span class="no">tau2</span>         <span class="kw">&lt;-</span> <span class="fl">10</span> * <span class="fl">2</span>^(<span class="fl">2</span> * (<span class="fl">1</span>:<span class="no">M</span> - <span class="fl">1</span>))
<span class="no">Q_alpha_tau2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/make_Q_alpha_tau2.html">make_Q_alpha_tau2</a></span>(<span class="no">Q_alpha</span>, <span class="no">tau2</span>)

<span class="co">## initialize the random effect</span>
<span class="co">## set up a linear constraint so that each resolution sums to one</span>
<span class="no">A_constraint</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>){
        <span class="no">tmp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n_dims</span>))
        <span class="no">tmp</span>[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">i</span>] <span class="kw">&lt;-</span> <span class="fl">1</span>
        <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>(<span class="no">tmp</span>)
    })

<span class="no">a_constraint</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="no">M</span>)
<span class="no">alpha</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span>(<span class="fu">rmvnorm.prec.const</span>(<span class="kw">n</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">mu</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">n_dims</span>)), <span class="kw">Q</span> <span class="kw">=</span> <span class="no">Q_alpha_tau2</span>, <span class="kw">A</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">A_constraint</span>), <span class="kw">a</span> <span class="kw">=</span> <span class="no">a_constraint</span>))

<span class="no">sigma2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html">runif</a></span>(<span class="fl">1</span>, <span class="fl">0.25</span>, <span class="fl">0.5</span>)

<span class="no">y</span> <span class="kw">&lt;-</span> <span class="no">X</span> <span class="kw">%*%</span> <span class="no">beta</span> + <span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span> + <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span>(<span class="no">N</span>, <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span>(<span class="no">sigma2</span>))</pre></body></html></div>
<p>Next, the sum-to-one constraint is verified by checking that within each dimension the sum of the <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> parameters is 0.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">alpha</span>)</pre></body></html></div>
<pre><code>## [1] 1.98782e-14</code></pre>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">alpha</span>[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="fl">1</span>])</pre></body></html></div>
<pre><code>## [1] 1.450229e-15</code></pre>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">alpha</span>[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="fl">2</span>])</pre></body></html></div>
<pre><code>## [1] 4.22995e-14</code></pre>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">alpha</span>[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="fl">3</span>])</pre></body></html></div>
<pre><code>## [1] -2.387153e-14</code></pre>
<div id="plotting-the-simulated-data" class="section level2">
<h2 class="hasAnchor">
<a href="#plotting-the-simulated-data" class="anchor"></a>Plotting the simulated data</h2>
<p>To explore the structure of the precision matrix of the spatial random effects, we plot the pattern of nonzero elements in the precision matrices <span class="math inline">\(\mathbf{Q}_{m}\)</span> for each resolution <span class="math inline">\(m\)</span>. The sparse, banded structure in the precision matrices at each resolution are what enable efficient computation.</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="co">## plot Q_alpha_tau2 structure</span>
<span class="co">## note: the display function gives a warning about the default cex setting</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/layout.html">layout</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span>(<span class="fl">1</span>:<span class="fl">4</span>, <span class="fl">2</span>, <span class="fl">2</span>, <span class="kw">byrow</span> <span class="kw">=</span> <span class="fl">TRUE</span>))
<span class="kw">for</span> (<span class="no">m</span> <span class="kw">in</span> <span class="fl">1</span>:<span class="no">M</span>) {
  <span class="fu">display</span>(<span class="no">Q_alpha_tau2</span>[<span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">m</span>), <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span>(<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">m</span>)])
  <span class="fu"><a href="https://rdrr.io/r/graphics/title.html">title</a></span>(<span class="kw">main</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Nonzero elements of \n precision matrix; resolution"</span>, <span class="no">m</span>))
}</pre></body></html></div>
<p><img src="plot-precision-matrices-1.png" title="plot of chunk plot-precision-matrices" alt="plot of chunk plot-precision-matrices" style="display: block; margin: auto;"></p>
<p>The MRA approach requires a set of grid point at each resolution. The set of grid points at each resolution extends beyond the spatial domain that is highlighted in the black box.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">1</span>])),
    <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">2</span>])),
    <span class="kw">resolution</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">i</span>, <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]])))))
) <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">resolution</span>)) +
    <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.75</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">0.75</span>) +
    <span class="fu">ggtitle</span>(<span class="st">"MRA grid points"</span>) +
    <span class="fu">theme_bw</span>() +
  <span class="fu">scale_colour_viridis_d</span>(<span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_rect</span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="kw">NULL</span>,
    <span class="fu">aes</span>(<span class="kw">xmin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">xmax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">ymin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>]),
        <span class="kw">ymax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>])
    ),
    <span class="kw">fill</span>  <span class="kw">=</span> <span class="fl">NA</span>,
    <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>,
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>
  ) +
  <span class="fu">theme_custom</span>()</pre></body></html></div>
<p><img src="MRA-grid-1.png" title="plot of chunk MRA-grid" alt="plot of chunk MRA-grid" style="display: block; margin: auto;"></p>
<p>At each internal grid cell, we expect there to be 68 neighbors where the Wendland basis is nonzero. The plot below shows the number of neighbors at each grid point for each resolution.</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">nnn</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) {
  <span class="no">D</span> <span class="kw">&lt;-</span> <span class="fu">rdist</span>(<span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]])
  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]]), <span class="kw">function</span>(<span class="no">j</span>) {
    <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>((<span class="no">D</span>[<span class="no">j</span>, ]) <span class="kw">&lt;</span> <span class="no">MRA</span>$<span class="no">radius</span>[<span class="no">i</span>])}
  )
})

<span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">1</span>])),
  <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">2</span>])),
  <span class="kw">resolution</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"resolution"</span>, <span class="no">i</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]]))))),
  <span class="no">neighbors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="no">nnn</span>)
)  <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">neighbors</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="fu">facet_wrap</span>(~ <span class="no">resolution</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"number of neighbors"</span>) +
  <span class="fu">scale_fill_viridis_c</span>() +
    <span class="fu">geom_rect</span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="kw">NULL</span>,
    <span class="fu">aes</span>(<span class="kw">xmin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">xmax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">ymin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>]),
        <span class="kw">ymax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>])
    ),
    <span class="kw">fill</span>  <span class="kw">=</span> <span class="fl">NA</span>,
    <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>,
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>
  ) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>()</pre></body></html></div>
<p><img src="plot-neighbors-1.png" title="plot of chunk plot-neighbors" alt="plot of chunk plot-neighbors" style="display: block; margin: auto;"></p>
<p>The next plot shows the simulated spatial random effects <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> at each of the grid points. Notice that the variation is largest for the coarse resolution and the variability decreases for each finer resolution.</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">sim_alphas</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">1</span>])),
    <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">2</span>])),
    <span class="kw">resolution</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"resolution"</span>, <span class="no">i</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]]))))),
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">alpha</span>[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">i</span>]))
) <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">alpha</span>)) +
    <span class="fu">geom_raster</span>() +
  <span class="fu">ggtitle</span>(<span class="st">"MRA spatial random effects"</span>) +
    <span class="fu">scale_fill_viridis_c</span>() +
    <span class="fu">geom_rect</span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="kw">NULL</span>,
    <span class="fu">aes</span>(<span class="kw">xmin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">xmax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">ymin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>]),
        <span class="kw">ymax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>])
    ),
    <span class="kw">fill</span>  <span class="kw">=</span> <span class="fl">NA</span>,
    <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>,
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>
  ) +
  <span class="fu">facet_wrap</span>( ~ <span class="no">resolution</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>()

<span class="no">sim_alphas</span></pre></body></html></div>
<p><img src="plot-random-effects-1.png" title="plot of chunk plot-random-effects" alt="plot of chunk plot-random-effects" style="display: block; margin: auto;"></p>
<p>Next, we show a simulated realization of the model. The left figure below shows the fixed effects in the model, the middle figure shows the simulated spatial process, and the right plot shows the observed surface.</p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="no">zlims</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">X</span> <span class="kw">%*%</span> <span class="no">beta</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>)),
  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">X</span> <span class="kw">%*%</span> <span class="no">beta</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y</span>), <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>))
)

<span class="no">g_fixed</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">X</span> <span class="kw">%*%</span> <span class="no">beta</span>),
  <span class="kw">x</span>    <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">1</span>],
  <span class="kw">y</span>    <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">2</span>]
) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">temp</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="fu">xlab</span>(<span class="st">"x"</span>) +
  <span class="fu">ylab</span>(<span class="st">"y"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Fixed effects"</span>) +
  <span class="kw pkg">colorspace</span><span class="kw ns">::</span><span class="fu">scale_fill_continuous_diverging</span>(<span class="st">"Blue-Red 3"</span>, <span class="kw">limits</span> <span class="kw">=</span> <span class="no">zlims</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.70</span>)</pre></body></html></div>
<pre><code>## Error in ggplot2::continuous_scale(aesthetics, "continuous_diverging", : object 'zlims' not found</code></pre>
<div class="sourceCode" id="cb16"><html><body><pre class="r"><span class="no">dat_map</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">temp</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">y</span>),
  <span class="kw">re</span>   <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>),
  <span class="kw">x</span>    <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">1</span>],
  <span class="kw">y</span>    <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">2</span>]
)

<span class="no">g_full</span> <span class="kw">&lt;-</span> <span class="no">dat_map</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">temp</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="fu">xlab</span>(<span class="st">"x"</span>) +
  <span class="fu">ylab</span>(<span class="st">"y"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Observed surface"</span>) +
  <span class="kw pkg">colorspace</span><span class="kw ns">::</span><span class="fu">scale_fill_continuous_diverging</span>(<span class="st">"Blue-Red 3"</span>, <span class="kw">limits</span> <span class="kw">=</span> <span class="no">zlims</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.70</span>)</pre></body></html></div>
<pre><code>## Error in ggplot2::continuous_scale(aesthetics, "continuous_diverging", : object 'zlims' not found</code></pre>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">g_re</span> <span class="kw">&lt;-</span> <span class="no">dat_map</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">re</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="fu">xlab</span>(<span class="st">"x"</span>) +
  <span class="fu">ylab</span>(<span class="st">"y"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Spatial process"</span>) +
  <span class="kw pkg">colorspace</span><span class="kw ns">::</span><span class="fu">scale_fill_continuous_diverging</span>(<span class="st">"Blue-Red 3"</span>, <span class="kw">limits</span> <span class="kw">=</span> <span class="no">zlims</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>) +
  <span class="fu">theme_custom</span>(<span class="fl">0.70</span>)</pre></body></html></div>
<pre><code>## Error in ggplot2::continuous_scale(aesthetics, "continuous_diverging", : object 'zlims' not found</code></pre>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">g_fixed</span> + <span class="no">g_re</span> + <span class="no">g_full</span> + <span class="fu">plot_layout</span>(<span class="kw">guides</span> <span class="kw">=</span> <span class="st">"collect"</span>)</pre></body></html></div>
<pre><code>## Error in eval(expr, envir, enclos): object 'g_fixed' not found</code></pre>
<p>To further examine how the spatial process is constructed, the plot below shows the contribution to the full spatial process (bottom right plot) from each of the different resolutions. The plot shows how the coarsest resolution (top left) produces a coarse process over large spatial resolutions and the finest resolution (lower left) produces a finer-scale process. The three (M) resolutions are added together to produce the full process.</p>
<div class="sourceCode" id="cb22"><html><body><pre class="r"><span class="co">## MRA spatial process</span>
<span class="no">W_alpha_res</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">m</span>) <span class="no">W</span>[, <span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">m</span>] <span class="kw">%*%</span> <span class="no">alpha</span>[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">m</span>], <span class="kw">simplify</span> <span class="kw">=</span> <span class="st">"matrix"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">W_alpha_res</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="kw">site</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">N</span>,
  <span class="kw">res</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"resolution"</span>, <span class="fl">1</span>:<span class="no">M</span>)
)
<span class="no">dat_locs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">site</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">N</span>,
  <span class="kw">x</span>    <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">1</span>],
  <span class="kw">y</span>    <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">2</span>]
)

<span class="no">sim_MRA</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="no">dat_locs</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">as.data.frame.table</a></span>(<span class="no">W_alpha_res</span>, <span class="kw">responseName</span> <span class="kw">=</span> <span class="st">"W_alpha"</span>)),
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">site</span>    <span class="kw">=</span> <span class="fl">1</span>:<span class="no">N</span>,
    <span class="kw">x</span>       <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">1</span>],
    <span class="kw">y</span>       <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">2</span>],
    <span class="kw">W_alpha</span> <span class="kw">=</span> <span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>,
    <span class="kw">res</span>     <span class="kw">=</span> <span class="st">"full process"</span>
  )
) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">W_alpha</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="fu">facet_wrap</span>( ~ <span class="no">res</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">xlab</span>(<span class="st">"x"</span>) +
  <span class="fu">ylab</span>(<span class="st">"y"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Multi-resolution process"</span>) +
  <span class="kw pkg">colorspace</span><span class="kw ns">::</span><span class="fu">scale_fill_continuous_diverging</span>(<span class="st">"Blue-Red 3"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>()
<span class="no">sim_MRA</span></pre></body></html></div>
<p><img src="plot-multiresolution-process-1.png" title="plot of chunk plot-multiresolution-process" alt="plot of chunk plot-multiresolution-process" style="display: block; margin: auto;"></p>
</div>
</div>
<div id="fitting-the-mra-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-the-mra-model" class="anchor"></a>Fitting the MRA model</h1>
<p>To explore how well the fitted model can predict out of sample data, we take a sample <span class="math inline">\(s\)</span> of size <span class="math inline">\(n_{sites}\)</span> from the <span class="math inline">\(N\)</span> simulated points and fit the model using <code><a href="../reference/mcmc_mra.html">mcmc_mra()</a></code>.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">111</span>)
<span class="no">n_sites</span>   <span class="kw">&lt;-</span> <span class="fl">500</span>
<span class="no">s</span>         <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">N</span>, <span class="no">n_sites</span>)
<span class="no">y_s</span>       <span class="kw">&lt;-</span> <span class="no">y</span>[<span class="no">s</span>, ]
<span class="no">y_oos</span>     <span class="kw">&lt;-</span> <span class="no">y</span>[ - <span class="no">s</span>, ]
<span class="no">X_s</span>       <span class="kw">&lt;-</span> <span class="no">X</span>[<span class="no">s</span>, ]
<span class="no">X_oos</span>     <span class="kw">&lt;-</span> <span class="no">X</span>[ - <span class="no">s</span>, ]
<span class="no">locs_s</span>    <span class="kw">&lt;-</span> <span class="no">locs</span>[<span class="no">s</span>, ]
<span class="no">locs_oos</span>  <span class="kw">&lt;-</span> <span class="no">locs</span>[ - <span class="no">s</span>, ]</pre></body></html></div>
<p>The plot below shows the sampled data to which the model is fit, showing the spatial patterns of the sampled data.</p>
<div class="sourceCode" id="cb24"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">x</span>     <span class="kw">=</span> <span class="no">locs_s</span>[, <span class="fl">1</span>],
  <span class="kw">y</span>     <span class="kw">=</span> <span class="no">locs_s</span>[, <span class="fl">2</span>],
  <span class="kw">site</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">1</span>:<span class="no">n_sites</span>),
  <span class="kw">y_s</span>     <span class="kw">=</span> <span class="no">y_s</span>
) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">y_s</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="kw pkg">colorspace</span><span class="kw ns">::</span><span class="fu">scale_fill_continuous_diverging</span>(<span class="st">"Blue-Red 3"</span>, <span class="kw">limits</span> <span class="kw">=</span> <span class="no">zlims</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Sampled y"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>() +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)</pre></body></html></div>
<pre><code>## Error in ggplot2::continuous_scale(aesthetics, "continuous_diverging", : object 'zlims' not found</code></pre>
<p>To fit the model, we must specify the parameters form model fitting. The parameter <code>params$n_adapt</code> determines the number of warm-up MCMC iterations and these iterations are discarded. The parameter <code>params$n_mcmc</code> determines the number of post warm-up MCMC iterations (i.e., the total number of MCMC iterations is <code>params$n_adapt + params$n_mcmc</code>). The parameter <code>params$n_thin</code> determines the thinning rate for keeping posterior samples which is primarily used when the number of MCMC samples to keep stresses the computer memory usage. The total number of samples kept is <code>params$n_mcmc / params$n_thin</code>. The parameter <code>params$n_message</code> specifies the frequency of messages to display showing the progress of the MCMC algorithm. The object <code>priors</code> defines the priors for fitting the model. If <code>priors</code> is not specified, default priors are used.</p>
<div class="sourceCode" id="cb26"><html><body><pre class="r"><span class="no">params</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="kw">n_mcmc</span>    <span class="kw">=</span> <span class="fl">500</span>,
  <span class="kw">n_adapt</span>   <span class="kw">=</span> <span class="fl">500</span>,
  <span class="kw">n_thin</span>    <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">n_message</span> <span class="kw">=</span> <span class="fl">50</span>
)

<span class="no">priors</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="kw">alpha_tau2</span>   <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">beta_tau2</span>    <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">alpha_sigma2</span> <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">beta_sigma2</span>  <span class="kw">=</span> <span class="fl">1</span>,
  <span class="kw">mu_beta</span>      <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X_s</span>)),
  <span class="kw">Sigma_beta</span>   <span class="kw">=</span> <span class="fl">5</span> * <span class="fu"><a href="https://rdrr.io/r/base/diag.html">diag</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X_s</span>)))</pre></body></html></div>
<p>Now we can fit the model to the simulated data. Using a <a href="https://www.tidyverse.org/blog/2017/12/workflow-vs-script/">project-oriented workflow</a>, we save the MCMC output that results from <code><a href="../reference/mcmc_mra.html">mcmc_mra()</a></code> in a folder named <code>results</code> in the current project.</p>
<div id="fitting-the-model-using-mcmc" class="section level2">
<h2 class="hasAnchor">
<a href="#fitting-the-model-using-mcmc" class="anchor"></a>Fitting the model using MCMC</h2>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span>(<span class="fl">999</span>)

<span class="kw">if</span> (<span class="fu"><a href="https://rdrr.io/r/base/files.html">file.exists</a></span>(<span class="kw pkg">here</span><span class="kw ns">::</span><span class="fu">here</span>(<span class="st">"results"</span>, <span class="st">"fit-mra-sim.RData"</span>))) {
  <span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span>(<span class="kw pkg">here</span><span class="kw ns">::</span><span class="fu">here</span>(<span class="st">"results"</span>, <span class="st">"fit-mra-sim.RData"</span>))
} <span class="kw">else</span> {
  <span class="no">start</span>   <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
  <span class="no">out</span>     <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/mcmc_mra.html">mcmc_mra</a></span>(
    <span class="kw">y</span>             <span class="kw">=</span> <span class="no">y_s</span>,
    <span class="kw">X</span>             <span class="kw">=</span> <span class="no">X_s</span>,
    <span class="kw">locs</span>          <span class="kw">=</span> <span class="no">locs_s</span>,
    <span class="kw">params</span>        <span class="kw">=</span> <span class="no">params</span>,
    <span class="kw">priors</span>        <span class="kw">=</span> <span class="no">priors</span>,
    <span class="kw">M</span>             <span class="kw">=</span> <span class="no">M</span>,
    <span class="kw">n_coarse_grid</span> <span class="kw">=</span> <span class="no">n_coarse</span>,
    <span class="kw">n_cores</span>       <span class="kw">=</span> <span class="fl">1L</span>,
    <span class="kw">verbose</span>       <span class="kw">=</span> <span class="fl">FALSE</span>
  )
  <span class="no">end</span>     <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html">Sys.time</a></span>()
  <span class="no">runtime</span> <span class="kw">&lt;-</span> <span class="no">end</span> - <span class="no">start</span>
  <span class="fu"><a href="https://rdrr.io/r/base/save.html">save</a></span>(<span class="no">out</span>, <span class="no">runtime</span>, <span class="kw">file</span> <span class="kw">=</span> <span class="kw pkg">here</span><span class="kw ns">::</span><span class="fu">here</span>(<span class="st">"results"</span>, <span class="st">"fit-mra-sim.RData"</span>))
}</pre></body></html></div>
<p>The fitting of <code><a href="../reference/mcmc_mra.html">mcmc_mra()</a></code> took 6.02 mins.</p>
</div>
</div>
<div id="examining-the-mra-mcmc-output" class="section level1">
<h1 class="hasAnchor">
<a href="#examining-the-mra-mcmc-output" class="anchor"></a>Examining the MRA MCMC output</h1>
<p>After fitting the MCMC using <code><a href="../reference/mcmc_mra.html">mcmc_mra()</a></code>, we plot the trace plots of the parameters to check for evidence that the model has not converged and to identify that the parameters have mixed. The first trace plots we examine are for the variance parameters and the regression coefficients. Overall, these trace plots look decent although the effective samples size for the <span class="math inline">\(\tau^2\)</span>s and <span class="math inline">\(\beta\)</span>s might be low and more samples might be needed for making inference with the model.</p>
<div class="sourceCode" id="cb28"><html><body><pre class="r"><span class="no">dat_tau2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">tau2</span>      <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">out</span>$<span class="no">tau2</span>),
  <span class="kw">iteration</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">tau2</span>), <span class="kw">times</span> <span class="kw">=</span> <span class="no">M</span>),
  <span class="kw">resolution</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">tau2</span>)))
)

<span class="no">p_tau2</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>(<span class="no">dat_tau2</span>, <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">tau2</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">resolution</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">resolution</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Trace plots for tau2"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.7</span>)

<span class="no">dat_lambda</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">lambda</span>      <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">out</span>$<span class="no">lambda</span>),
  <span class="kw">iteration</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">lambda</span>), <span class="kw">times</span> <span class="kw">=</span> <span class="no">M</span>),
  <span class="kw">resolution</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">lambda</span>)))
)

<span class="no">p_lambda</span> <span class="kw">&lt;-</span> <span class="fu">ggplot</span>(<span class="no">dat_lambda</span>, <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">lambda</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">resolution</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">resolution</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Trace plots for lambda"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.7</span>)


<span class="no">p_sigma2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">sigma2</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">out</span>$<span class="no">sigma2</span>), <span class="kw">iteration</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">out</span>$<span class="no">sigma2</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">sigma2</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Trace plots for sigma2"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.7</span>)

<span class="no">dat_beta</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">beta</span>      <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">out</span>$<span class="no">beta</span>),
  <span class="kw">iteration</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">beta</span>), <span class="kw">times</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>)),
  <span class="kw">covariate</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">X</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">beta</span>)))
)
<span class="no">p_beta</span>  <span class="kw">&lt;-</span> <span class="fu">ggplot</span>(<span class="no">dat_beta</span>, <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">beta</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">covariate</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">covariate</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Trace plots for beta"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.7</span>)

(<span class="no">p_tau2</span> + <span class="no">p_lambda</span>) /  (<span class="no">p_sigma2</span> + <span class="no">p_beta</span>)</pre></body></html></div>
<p><img src="trace-plots-1.png" title="plot of chunk trace-plots" alt="plot of chunk trace-plots" style="display: block; margin: auto;"></p>
<p>Next, the trace plots for the spatial parameter <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> are shown. Because there are so many parameters, a sample is taken for plotting. These trace plots suggest that perhaps <span class="math inline">\(\boldsymbol{\alpha}\)</span> hasn’t entirely converged. However, as there is a non-identifiability between <span class="math inline">\(\tau^2_m\)</span> and <span class="math inline">\(\boldsymbol{\alpha}_m\)</span>, this is not surprising and might not be remedied with more samples.</p>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="co">## posterior plots for alpha</span>

<span class="no">dat_alpha</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">alpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="no">out</span>$<span class="no">alpha</span>),
  <span class="kw">iteration</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">out</span>$<span class="no">alpha</span>), <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">ncol</a></span>(<span class="no">out</span>$<span class="no">alpha</span>)),
  <span class="kw">knot</span>      <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">m</span>) <span class="fl">1</span>:<span class="no">n_dims</span>[<span class="no">m</span>]))),
  <span class="kw">resolution</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"resolution"</span>, <span class="no">dims_idx</span>))
)

<span class="no">plot_idx</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">m</span>) <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span>(<span class="no">n_dims</span>[<span class="no">m</span>], <span class="fl">10</span>))

<span class="no">dat_alpha</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/subset.html">subset</a></span>(
    (<span class="no">resolution</span> <span class="kw">==</span> <span class="st">"resolution 1"</span> <span class="kw">&amp;</span> <span class="no">knot</span> <span class="kw">%in%</span> <span class="no">plot_idx</span>[, <span class="fl">1</span>]) <span class="kw">|</span>
      (<span class="no">resolution</span> <span class="kw">==</span> <span class="st">"resolution 2"</span> <span class="kw">&amp;</span> <span class="no">knot</span> <span class="kw">%in%</span> <span class="no">plot_idx</span>[, <span class="fl">2</span>]) <span class="kw">|</span>
      (<span class="no">resolution</span> <span class="kw">==</span> <span class="st">"resolution 3"</span> <span class="kw">&amp;</span> <span class="no">knot</span> <span class="kw">%in%</span> <span class="no">plot_idx</span>[, <span class="fl">3</span>])
  ) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">iteration</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">alpha</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">knot</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">knot</span>)) +
  <span class="fu">geom_line</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">facet_wrap</span>( ~ <span class="no">resolution</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">1</span>) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Trace plots for alpha"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.7</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)</pre></body></html></div>
<p><img src="trace-plots-alpha-1.png" title="plot of chunk trace-plots-alpha" alt="plot of chunk trace-plots-alpha" style="display: block; margin: auto;"></p>
<p>Because the model was fit to simulated data, the posterior predictions can be compared to the simulated parameters to evaluate the model performance. The following plots show the 95% central credible intervals for different parameters plotted against the simulated parameters. For the regression parameters <span class="math inline">\(\boldsymbol{\beta}\)</span>, the model is doing a reasonable job of recovering these parameters. The parameter estimates for <span class="math inline">\(\tau^2_m\)</span> and <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> show poor performance in estimating the true parameters. This is due to a non-identifiability in the model; however, this is not a concern as the spatial process <span class="math inline">\(\sum_{m=1}^M \mathbf{W}_m \boldsymbol{\alpha}_m\)</span> is well estimated which will be shown later.</p>
<div class="sourceCode" id="cb30"><html><body><pre class="r"><span class="co">## predicted vs. estimated beta</span>
<span class="no">dat_plot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">truth</span> <span class="kw">=</span> <span class="no">beta</span>,
  <span class="kw">mean</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">beta</span>, <span class="fl">2</span>, <span class="no">mean</span>),
  <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">beta</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.025</span>),
  <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">beta</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.975</span>),
  <span class="kw">parameter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">beta</span>))
)

<span class="no">p_beta</span> <span class="kw">&lt;-</span> <span class="no">dat_plot</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">truth</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">parameter</span>)) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper</span>)) +
  <span class="fu">ylab</span>(<span class="st">"estimate"</span>) +
  <span class="fu">geom_abline</span>(<span class="kw">intercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">slope</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. predicted beta"</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="co">## predicted vs. estimated sigma2</span>
<span class="no">p_sigma2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">sigma2</span> <span class="kw">=</span> <span class="no">out</span>$<span class="no">sigma2</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">y</span> <span class="kw">=</span> <span class="no">sigma2</span>)) +
  <span class="fu">geom_boxplot</span>() +
  <span class="fu">geom_point</span>(<span class="kw">data</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(<span class="kw">sigma2</span> <span class="kw">=</span> <span class="no">sigma2</span>),
             <span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">sigma2</span>), <span class="kw">color</span> <span class="kw">=</span> <span class="st">"red"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">ylab</span>(<span class="st">"estimate"</span>) +
  <span class="fu">xlab</span>(<span class="st">"sigma2"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. predicted sigma2"</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>,
        <span class="kw">axis.text.x</span>  <span class="kw">=</span> <span class="fu">element_blank</span>(),
        <span class="kw">axis.ticks.x</span> <span class="kw">=</span> <span class="fu">element_blank</span>())

<span class="co">## predicted vs. estimated tau2</span>
<span class="no">dat_plot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">truth</span> <span class="kw">=</span> <span class="no">tau2</span>,
  <span class="kw">mean</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">tau2</span>, <span class="fl">2</span>, <span class="no">mean</span>),
  <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">tau2</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.025</span>),
  <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">tau2</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.975</span>),
  <span class="kw">parameter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">tau2</span>))
)


<span class="no">p_tau2</span> <span class="kw">&lt;-</span> <span class="no">dat_plot</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">truth</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">parameter</span>)) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper</span>)) +
  <span class="fu">ylab</span>(<span class="st">"estimate"</span>) +
  <span class="fu">geom_abline</span>(<span class="kw">intercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">slope</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. predicted tau2"</span>) +
  <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"none"</span>)

<span class="co"># plot alpha estimates</span>
<span class="no">dat_plot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">truth</span> <span class="kw">=</span> <span class="no">alpha</span>,
  <span class="kw">mean</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">alpha</span>, <span class="fl">2</span>, <span class="no">mean</span>),
  <span class="kw">lower</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">alpha</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.025</span>),
  <span class="kw">upper</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">alpha</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.975</span>),
  <span class="kw">parameter</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fl">1</span>:<span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">alpha</span>)),
  <span class="kw">res</span>       <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="no">dims_idx</span>)
)

<span class="no">p_alpha</span> <span class="kw">&lt;-</span> <span class="no">dat_plot</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">truth</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean</span>, <span class="kw">color</span> <span class="kw">=</span> <span class="no">res</span>)) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">geom_linerange</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper</span>)) +
  <span class="fu">geom_abline</span>(<span class="kw">intercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">slope</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. predicted alpha /nnon-identifialbe but not really a concern"</span>) +
  <span class="fu">ylab</span>(<span class="st">"estimate"</span>)

(<span class="no">p_beta</span> + <span class="no">p_sigma2</span>) / (<span class="no">p_tau2</span> + <span class="no">p_alpha</span>)</pre></body></html></div>
<p><img src="estimated-vs-predicted-1.png" title="plot of chunk estimated-vs-predicted" alt="plot of chunk estimated-vs-predicted" style="display: block; margin: auto;"></p>
<p>Next, the simulated and estimated <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> are plotted on the spatial grid. The plots show that the <span class="math inline">\(\boldsymbol{\alpha}_m\)</span>s are not being identified.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="no">fitted_alphas</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">x</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">1</span>])),
    <span class="kw">y</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]][, <span class="fl">2</span>])),
    <span class="kw">res</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="no">i</span>, <span class="kw">each</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span>(<span class="no">MRA</span>$<span class="no">locs_grid</span><span class="kw">[[</span><span class="no">i</span>]]))))),
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">i</span>) <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">alpha</span>, <span class="fl">2</span>, <span class="no">mean</span>)[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">i</span>]))
) <span class="kw">%&gt;%</span>
    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">y</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">alpha</span>)) +
    <span class="fu">geom_raster</span>() +
    <span class="fu">scale_fill_viridis_c</span>() +
  <span class="fu">ggtitle</span>(<span class="st">"Posterior mean spatial random effects"</span>) +
  <span class="fu">facet_wrap</span>( ~ <span class="no">res</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">geom_rect</span>(
    <span class="kw">data</span> <span class="kw">=</span> <span class="kw">NULL</span>,
    <span class="fu">aes</span>(<span class="kw">xmin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">xmax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">1</span>]),
        <span class="kw">ymin</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>]),
        <span class="kw">ymax</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">locs</span>[, <span class="fl">2</span>])
    ),
    <span class="kw">fill</span>  <span class="kw">=</span> <span class="fl">NA</span>,
    <span class="kw">color</span> <span class="kw">=</span> <span class="st">"black"</span>,
    <span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>
  ) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.5</span>)
<span class="no">sim_alphas</span> + <span class="fu">theme_custom</span>(<span class="fl">0.5</span>) + <span class="no">fitted_alphas</span></pre></body></html></div>
<p><img src="estimated-alphas-1.png" title="plot of chunk estimated-alphas" alt="plot of chunk estimated-alphas" style="display: block; margin: auto;"></p>
<p>Despite the parameters <span class="math inline">\(\tau^2_m\)</span> and <span class="math inline">\(\boldsymbol{\alpha}_m\)</span> not being identifiable, the following plot shows that the full spatial process <span class="math inline">\(\sum_{m=1}^M \mathbf{W}_m \boldsymbol{\alpha}_m\)</span>. The two figures (simulated on the left, fitted on the right) demonstrate that each of the <span class="math inline">\(m\)</span> resolutions of the process <span class="math inline">\(\mathbf{W}_m \boldsymbol{\alpha}_m\)</span> are also non-identifiable.</p>
<div class="sourceCode" id="cb32"><html><body><pre class="r"><span class="co">## Estimated MRA spatial proces</span>
<span class="no">W_alpha_res</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/lapply.html">sapply</a></span>(<span class="fl">1</span>:<span class="no">M</span>, <span class="kw">function</span>(<span class="no">m</span>) <span class="no">W</span>[, <span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">m</span>] <span class="kw">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">out</span>$<span class="no">alpha</span>, <span class="fl">2</span>, <span class="no">mean</span>)[<span class="no">dims_idx</span> <span class="kw">==</span> <span class="no">m</span>], <span class="kw">simplify</span> <span class="kw">=</span> <span class="st">"matrix"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/dimnames.html">dimnames</a></span>(<span class="no">W_alpha_res</span>) <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
  <span class="kw">site</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">N</span>,
  <span class="kw">res</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"resolution"</span>, <span class="fl">1</span>:<span class="no">M</span>)
)
<span class="no">dat_locs</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">site</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">N</span>,
  <span class="kw">lat</span>  <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">2</span>],
  <span class="kw">lon</span>  <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">1</span>]
)

<span class="no">estimated_MRA</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span>(
  <span class="fu"><a href="https://rdrr.io/r/base/merge.html">merge</a></span>(<span class="no">dat_locs</span>, <span class="fu"><a href="https://rdrr.io/r/base/table.html">as.data.frame.table</a></span>(<span class="no">W_alpha_res</span>, <span class="kw">responseName</span> <span class="kw">=</span> <span class="st">"W_alpha"</span>)),
  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
    <span class="kw">site</span> <span class="kw">=</span> <span class="fl">1</span>:<span class="no">N</span>,
    <span class="kw">lat</span>  <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">2</span>],
    <span class="kw">lon</span>  <span class="kw">=</span> <span class="no">locs</span>[, <span class="fl">1</span>],
    <span class="kw">W_alpha</span> <span class="kw">=</span> <span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>,
    <span class="kw">res</span> <span class="kw">=</span> <span class="st">"full process"</span>
  )
) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">lon</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">lat</span>, <span class="kw">fill</span> <span class="kw">=</span> <span class="no">W_alpha</span>)) +
  <span class="fu">geom_raster</span>() +
  <span class="fu">facet_wrap</span>( ~ <span class="no">res</span>, <span class="kw">ncol</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">xlab</span>(<span class="st">"Longitude"</span>) +
  <span class="fu">ylab</span>(<span class="st">"Latitude"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated Multi-resolution process"</span>) +
  <span class="kw pkg">colorspace</span><span class="kw ns">::</span><span class="fu">scale_fill_continuous_diverging</span>(<span class="st">"Blue-Red 3"</span>) +
  <span class="fu">theme_bw</span>() +
  <span class="fu">theme_custom</span>(<span class="fl">0.5</span>)

<span class="no">sim_MRA</span> + <span class="fu">theme_custom</span>(<span class="fl">0.5</span>) + <span class="no">estimated_MRA</span></pre></body></html></div>
<p><img src="simulated-vs-estimated-process-1.png" title="plot of chunk simulated-vs-estimated-process" alt="plot of chunk simulated-vs-estimated-process" style="display: block; margin: auto;"></p>
<p>The next plots show the estimated vs. simulated fixed effects, spatial process, and mean response. There is some evidence of non-identifiability between the fixed effects plot and the spatial effects plot (left two plots) as there is a bias in each of the predictions. This is understood to be a consequence of spatial confounding (<span class="citation">Hodges and Reich (2010)</span>, <span class="citation">Hughes and Haran (2013)</span>, <span class="citation">Hanks et al. (2015)</span>).</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="co">## plot estimated mean response</span>
<span class="no">Xbeta_post</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">X_s</span> <span class="kw">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">out</span>$<span class="no">beta</span>))
<span class="no">Walpha_post</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/do.call.html">do.call</a></span>(<span class="no">cbind</span>, <span class="no">out</span>$<span class="no">MRA</span>$<span class="no">W</span>) <span class="kw">%*%</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html">t</a></span>(<span class="no">out</span>$<span class="no">alpha</span>))
<span class="no">mu_post</span> <span class="kw">&lt;-</span> <span class="no">Xbeta_post</span> + <span class="no">Walpha_post</span>

<span class="no">dat_plot</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">mean_Xbeta</span>   <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Xbeta_post</span>, <span class="fl">2</span>, <span class="no">mean</span>),
  <span class="kw">lower_Xbeta</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Xbeta_post</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.025</span>),
  <span class="kw">upper_Xbeta</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Xbeta_post</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.975</span>),
  <span class="kw">truth_Xbeta</span>  <span class="kw">=</span> <span class="no">X_s</span> <span class="kw">%*%</span> <span class="no">beta</span>,

  <span class="kw">mean_Walpha</span>  <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Walpha_post</span>, <span class="fl">2</span>, <span class="no">mean</span>),
  <span class="kw">lower_Walpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Walpha_post</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.025</span>),
  <span class="kw">upper_Walpha</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">Walpha_post</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.975</span>),
  <span class="kw">truth_Walpha</span> <span class="kw">=</span> (<span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>)[<span class="no">s</span>],

  <span class="kw">mean_mu</span>      <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">mu_post</span>, <span class="fl">2</span>, <span class="no">mean</span>),
  <span class="kw">lower_mu</span>     <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">mu_post</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.025</span>),
  <span class="kw">upper_mu</span>     <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span>(<span class="no">mu_post</span>, <span class="fl">2</span>, <span class="no">quantile</span>, <span class="kw">prob</span> <span class="kw">=</span> <span class="fl">0.975</span>),
  <span class="kw">truth_mu</span>     <span class="kw">=</span> <span class="no">X_s</span> <span class="kw">%*%</span> <span class="no">beta</span> + (<span class="no">W</span> <span class="kw">%*%</span> <span class="no">alpha</span>)[<span class="no">s</span>]
)

<span class="no">plot_Xbeta</span> <span class="kw">&lt;-</span> <span class="no">dat_plot</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">truth_Xbeta</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean_Xbeta</span>)) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower_Xbeta</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper_Xbeta</span>)) +
  <span class="fu">geom_abline</span>(<span class="kw">intercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">slope</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. simulated fixed effects"</span>)

<span class="no">plot_Walpha</span> <span class="kw">&lt;-</span> <span class="no">dat_plot</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">truth_Walpha</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean_Walpha</span>)) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower_Walpha</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper_Walpha</span>)) +
  <span class="fu">geom_abline</span>(<span class="kw">intercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">slope</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. simulated spatial process"</span>)

<span class="no">plot_mu</span> <span class="kw">&lt;-</span> <span class="no">dat_plot</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">truth_mu</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">mean_mu</span>)) +
  <span class="fu">scale_color_viridis_d</span>(<span class="kw">begin</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">end</span> <span class="kw">=</span> <span class="fl">0.8</span>) +
  <span class="fu">geom_point</span>(<span class="kw">alpha</span> <span class="kw">=</span> <span class="fl">0.5</span>) +
  <span class="fu">geom_errorbar</span>(<span class="fu">aes</span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">lower_mu</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">upper_mu</span>)) +
  <span class="fu">geom_abline</span>(<span class="kw">intercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">slope</span> <span class="kw">=</span> <span class="fl">1</span>, <span class="kw">col</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">ggtitle</span>(<span class="st">"Estimated vs. simulated mean response"</span>)

<span class="no">plot_Xbeta</span> + <span class="no">plot_Walpha</span> + <span class="no">plot_mu</span></pre></body></html></div>
<p><img src="plot-sim-vs-fitted-effects-1.png" title="plot of chunk plot-sim-vs-fitted-effects" alt="plot of chunk plot-sim-vs-fitted-effects" style="display: block; margin: auto;"></p>
</div>
<div id="references" class="section level1 unnumbered">
<h1 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h1>
<div id="refs" class="references">
<div id="ref-hanks2015restricted">
<p>Hanks, Ephraim M, Erin M Schliep, Mevin B Hooten, and Jennifer A Hoeting. 2015. “Restricted Spatial Regression in Practice: Geostatistical Models, Confounding, and Robustness Under Model Misspecification.” <em>Environmetrics</em> 26 (4). Wiley Online Library: 243–54.</p>
</div>
<div id="ref-hodges2010adding">
<p>Hodges, James S, and Brian J Reich. 2010. “Adding Spatially-Correlated Errors Can Mess up the Fixed Effect You Love.” <em>The American Statistician</em> 64 (4). Taylor &amp; Francis: 325–34.</p>
</div>
<div id="ref-hughes2013dimension">
<p>Hughes, John, and Murali Haran. 2013. “Dimension Reduction and Alleviation of Confounding for Spatial Generalized Linear Mixed Models.” <em>Journal of the Royal Statistical Society: Series B (Statistical Methodology)</em> 75 (1). Wiley Online Library: 139–59.</p>
</div>
<div id="ref-nychka2015multiresolution">
<p>Nychka, Douglas, Soutir Bandyopadhyay, Dorit Hammerling, Finn Lindgren, and Stephan Sain. 2015. “A Multiresolution Gaussian Process Model for the Analysis of Large Spatial Datasets.” <em>Journal of Computational and Graphical Statistics</em> 24 (2). Taylor &amp; Francis: 579–99.</p>
</div>
<div id="ref-LatticeKrig">
<p>Nychka, Douglas, Dorit Hammerling, Stephan Sain, and Nathan Lenssen. 2016. “LatticeKrig: Multiresolution Kriging Based on Markov Random Fields.” Boulder, CO, USA: University Corporation for Atmospheric Research. <a href="https://github.com/NCAR/LatticeKrig" class="uri">https://github.com/NCAR/LatticeKrig</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by John Tipton.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
